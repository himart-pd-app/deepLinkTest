<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>DeepLink Test</title>
  <style>
    body { 
      font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
      padding: 24px; 
      line-height: 1.8; 
      font-size: 16px;
    }
    h2 {
      font-size: 20px;
      margin-bottom: 10px;
    }
    textarea {
      display: block;
      width: 100%;
      box-sizing: border-box;
      padding: 16px;
      margin-top: 16px;
      font-size: 16px;
      border: 2px solid #ccc;
      border-radius: 8px;
      height: 240px;
      resize: vertical;
      line-height: 1.5;
    }
    button {
      width: 100%;
      padding: 16px;
      margin-top: 16px;
      font-size: 16px;
      background: #0366d6;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    button:nth-of-type(2) {
      background: #28a745;
    }
    button:nth-of-type(3) {
      background: #6f42c1;
    }
    button:active {
      opacity: 0.85;
    }
  </style>
</head>
<body>

  <h2>ğŸ“± DeepLink í…ŒìŠ¤íŠ¸ í˜ì´ì§€!</h2>

  <p>ì•„ë˜ ìŠ¤í‚´ ë˜ëŠ” URLì„ ë„£ê³  ë²„íŠ¼ì„ ëˆŒëŸ¬ í…ŒìŠ¤íŠ¸í•˜ì„¸ìš”.<br>
  Safari / Chrome / ì¸ì•± ë¸Œë¼ìš°ì €ì—ì„œ <b>window.location.href í˜¸ì¶œ í…ŒìŠ¤íŠ¸ë¥¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

  <!-- ê¸°ë³¸ í…ŒìŠ¤íŠ¸ ê°’ ìë™ ì…ë ¥ -->
  <textarea id="url" placeholder="ì˜ˆ: himartapp://url í˜•ì‹">mode=store&url=https%3A%2F%2Fwww.e-himart.co.kr%2Fapp%2FdisplayPlan%2FlistPlanDetail%3FspdpNo%3D12109</textarea>

  <button onclick="openScheme()">window.location.href í…ŒìŠ¤íŠ¸</button>
  <!-- <button onclick="openByIframe()">iframe ë°©ì‹ í…ŒìŠ¤íŠ¸ (iOS ìŠ¤í‚´ ì¶”ì²œ)</button>
  <button onclick="openAsLink()">a íƒœê·¸ í…ŒìŠ¤íŠ¸</button> -->
  <button onclick="parseAndRun()">ì‹ ê·œ ë”¥ë§í¬ í…ŒìŠ¤íŠ¸</button>
  <button onclick="runAosAppOld()">ê¸°ì¡´ AOS í…ŒìŠ¤íŠ¸</button>
  <button onclick="runIosAppOld()">ê¸°ì¡´ iOS í…ŒìŠ¤íŠ¸</button>

  <script>
    var appCheckTimer = null;

    function preventPopup(){
  		if (appCheckTimer) {
  			clearTimeout(appCheckTimer);
  			appCheckTimer = null;
  		}
  		window.removeEventListener('pagehide', preventPopup);
  		document.removeEventListener('visibilitychange', onVisibilityChange);
  	}

  	function onVisibilityChange() {
  		if (document.hidden) {
  			preventPopup();
  		}
  	}

    function openApp(webUrl, fallbackMode) {
      const ua = navigator.userAgent.toLowerCase();
      const mode = (fallbackMode === 'store') ? 'store' : 'web';

      if (/iphone|ipad|ipod/.test(ua)) {
        runIosApp(webUrl, mode);
      } else {
        runAosApp(webUrl, mode);
      }
    }

    function parseAndRun() {
      const raw = document.getElementById('url').value.trim();

      if (!raw) {
        alert('url=...&mode=web|store í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš”.');
        return;
      }

      const params = parseParamString(raw);

      if (!params.url) {
        alert('url íŒŒë¼ë¯¸í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì˜ˆ: url=https%3A%2F%2F...&mode=web');
        return;
      }

      const decodedUrl = decodeURIComponent(params.url);
      const mode = (params.mode === 'store') ? 'store' : 'web';

      console.log('[parseAndRun] íŒŒì‹± ê²°ê³¼:', { decodedUrl, mode, rawParams: params });

      openAppFromWebUrl(decodedUrl, mode);
    }

    function openAppFromWebUrl(webUrl, fallbackMode) {
      if (!webUrl) {
        console.log('openAppFromWebUrl: webUrl ì—†ìŒ');
        return;
      }
      const trimmed = webUrl.trim();
      if (!trimmed.startsWith('http')) {
        console.warn('webUrlì´ http/httpsë¡œ ì‹œì‘í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤:', trimmed);
      }

      console.log('openAppFromWebUrl:', { webUrl: trimmed, fallbackMode });
      openApp(trimmed, fallbackMode);
    }

    function parseParamString(paramStr) {
      const params = {};
      const parts = paramStr.split('&');

      parts.forEach(p => {
        const [key, value] = p.split('=');
        if (key && value !== undefined) {
          params[key.trim()] = value.trim();
        }
      });

      return params;
    }
  
    function runAosApp(webUrl, fallbackMode) {
      let intentUrl;
      
      if (fallbackMode === 'store') {
        intentUrl =
          'intent://' + webUrl +
          '#Intent;scheme=himartapp;package=com.himart.main;end';
      } else {
        intentUrl =
          'intent://' + webUrl +
          '#Intent;scheme=himartapp;package=com.himart.main;' +
          'S.browser_fallback_url=' + encodeURIComponent(webUrl) + ';end';
      }
      
	    window.location.href = intentUrl;
    }
  
    function runIosApp(webUrl, fallbackMode) {
  		const scheme = 'himartapp://' + webUrl;
      const fallbackUrl = (fallbackMode === 'store') ? 'https://itunes.apple.com/kr/app/id503522370' : webUrl;
  		
      appCheckTimer = setTimeout(function() {
        window.location.replace(fallbackUrl);
      }, 600);
    
      window.addEventListener('pagehide', preventPopup);
      document.addEventListener('visibilitychange', onVisibilityChange);
      
	    window.location.href = scheme;
  	}
  	  
    function runAosAppOld() {
      const scheme = document.getElementById('scheme').value.trim();
      const url = scheme.replace("himartapp://", "");
      const clickedAt = +new Date;
      appCheckTimer = setTimeout(function() {
        if (+new Date - clickedAt < 3000) {
          window.location.replace(url);
        } else {
          window.close();
        }
      }, 2500);
      window.location.href = 'intent://' + url + '#Intent;scheme=himartapp;package=com.himart.main;end'		
      window.addEventListener('pagehide', preventPopup);
    }
	  
	  function runIosAppOld() {
		  const scheme = document.getElementById('scheme').value.trim();
		  const url = scheme.replace("himartapp://", "");
		  const clickedAt = +new Date;
		  appCheckTimer = setTimeout(function() {
			  if (+new Date - clickedAt < 500) {
				  window.location.replace(url);
			  } else {
				  window.close();
			  }
		  }, 200);
		  window.location.href = scheme;
		  window.addEventListener('pagehide', preventPopup);
	  }
    
    function openScheme() {
      const url = document.getElementById('scheme').value.trim();
      if (!url) return alert("URL ë˜ëŠ” ìŠ¤í‚´ì„ ì…ë ¥í•˜ì„¸ìš”.");
      console.log("window.location.href =", url);
      window.location.href = url;
    }

    function openByIframe() {
      const url = document.getElementById('scheme').value.trim();
      if (!url) return alert("URL ë˜ëŠ” ìŠ¤í‚´ì„ ì…ë ¥í•˜ì„¸ìš”.");
      console.log("iframe.src =", url);
      const iframe = document.createElement('iframe');
      iframe.style.display = 'none';
      iframe.src = url;
      document.body.appendChild(iframe);
    }

    function openAsLink() {
      const url = document.getElementById('scheme').value.trim();
      if (!url) return alert("URL ë˜ëŠ” ìŠ¤í‚´ì„ ì…ë ¥í•˜ì„¸ìš”.");
      const a = document.createElement('a');
      a.href = url;
      a.innerText = "í…ŒìŠ¤íŠ¸ ë§í¬ (í´ë¦­)";
      a.style.display = 'block';
      a.style.fontSize = "22px";
      a.style.marginTop = "16px";
      document.body.appendChild(a);
    }
  </script>

</body>
</html>
