<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>DeepLink Test</title>
  <style>
    body { 
      font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
      padding: 24px; 
      line-height: 1.8; 
      font-size: 16px;
    }
    h2 {
      font-size: 20px;
      margin-bottom: 10px;
    }
    textarea {
      display: block;
      width: 100%;
      box-sizing: border-box;
      padding: 16px;
      margin-top: 16px;
      font-size: 16px;
      border: 2px solid #ccc;
      border-radius: 8px;
      height: 240px;
      resize: vertical;
      line-height: 1.5;
    }
    button {
      width: 100%;
      padding: 16px;
      margin-top: 16px;
      font-size: 16px;
      background: #0366d6;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    button:nth-of-type(2) {
      background: #28a745;
    }
    button:nth-of-type(3) {
      background: #6f42c1;
    }
    button:active {
      opacity: 0.85;
    }
  </style>
</head>
<body>

  <h2>ğŸ“± DeepLink í…ŒìŠ¤íŠ¸ í˜ì´ì§€!</h2>

  <p>ì•„ë˜ ìŠ¤í‚´ ë˜ëŠ” URLì„ ë„£ê³  ë²„íŠ¼ì„ ëˆŒëŸ¬ í…ŒìŠ¤íŠ¸í•˜ì„¸ìš”.<br>
  Safari / Chrome / ì¸ì•± ë¸Œë¼ìš°ì €ì—ì„œ <b>window.location.href í˜¸ì¶œ í…ŒìŠ¤íŠ¸ë¥¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

  <!-- ê¸°ë³¸ í…ŒìŠ¤íŠ¸ ê°’ ìë™ ì…ë ¥ -->
  <textarea id="scheme" placeholder="ì˜ˆ: himartapp://url í˜•ì‹">himartapp://https://www.e-himart.co.kr/app/displayPlan/listPlanDetail?spdpNo=12109</textarea>

  <button onclick="openScheme()">window.location.href í…ŒìŠ¤íŠ¸</button>
  <!-- <button onclick="openByIframe()">iframe ë°©ì‹ í…ŒìŠ¤íŠ¸ (iOS ìŠ¤í‚´ ì¶”ì²œ)</button>
  <button onclick="openAsLink()">a íƒœê·¸ í…ŒìŠ¤íŠ¸</button> -->
  <button onclick="runAosApp()">ì‹ ê·œ AOS í…ŒìŠ¤íŠ¸</button>
  <button onclick="runIosApp()">ì‹ ê·œ iOS í…ŒìŠ¤íŠ¸</button>
  <button onclick="runAosAppOld()">ê¸°ì¡´ AOS í…ŒìŠ¤íŠ¸</button>
  <button onclick="runIosAppOld()">ê¸°ì¡´ iOS í…ŒìŠ¤íŠ¸</button>

  <script>
    var appCheckTimer = null;

    function preventPopup(){
  		if (appCheckTimer) {
  			clearTimeout(appCheckTimer);
  			appCheckTimer = null;
  		}
  		window.removeEventListener('pagehide', preventPopup);
  		document.removeEventListener('visibilitychange', onVisibilityChange);
  	}

  	function onVisibilityChange() {
  		if (document.hidden) {
  			preventPopup();
  		}
  	}

    function setupFallbackTimer(url, delayMs, thresholdMs) {
      const clickedAt = Date.now();
    
      appCheckTimer = setTimeout(function() {
        const diff = Date.now() - clickedAt;
        if (diff < thresholdMs) {
          window.location.replace(url);
        }
        preventPopup();
      }, delayMs);
    
      window.addEventListener('pagehide', preventPopup);
      document.addEventListener('visibilitychange', onVisibilityChange);
    }
  
    function runAosApp() {
      const url = document.getElementById('scheme').value.trim().replace("himartapp://", "");

      setupFallbackTimer(url, 1500, 3000);
      
      window.location.href = 'intent://open#Intent;scheme=himartapp;package=com.himart.main;S.browser_fallback_url=' + encodeURIComponent(url) + ';end';
    }
  	  
    function runAosAppOld() {
      const scheme = document.getElementById('scheme').value.trim();
      const url = scheme.replace("himartapp://", "");
      const clickedAt = +new Date;
      appCheckTimer = setTimeout(function() {
        if (+new Date - clickedAt < 3000) {
          window.location.replace(url);
        } else {
          window.close();
        }
      }, 2500);
      window.location.href = 'intent://' + url + '#Intent;scheme=himartapp;package=com.himart.main;end'		
      window.addEventListener('pagehide', preventPopup);
    }
  
    function runIosApp() {
  		const scheme = document.getElementById('scheme').value.trim();
  		const url = scheme.replace("himartapp://", "");
  		
      setupFallbackTimer(url, 1500, 3000);
      
  		// const iframe = document.createElement('iframe');
  		// iframe.style.display = 'none';
  		// iframe.src = scheme;
  		// document.body.appendChild(iframe);
		  window.location.href = scheme;
  	}
	  
	  function runIosAppOld() {
		  const scheme = document.getElementById('scheme').value.trim();
		  const url = scheme.replace("himartapp://", "");
		  const clickedAt = +new Date;
		  appCheckTimer = setTimeout(function() {
			  if (+new Date - clickedAt < 500) {
				  window.location.replace(url);
			  } else {
				  window.close();
			  }
		  }, 200);
		  window.location.href = scheme;
		  window.addEventListener('pagehide', preventPopup);
	  }
    
    function openScheme() {
      const url = document.getElementById('scheme').value.trim();
      if (!url) return alert("URL ë˜ëŠ” ìŠ¤í‚´ì„ ì…ë ¥í•˜ì„¸ìš”.");
      console.log("window.location.href =", url);
      window.location.href = url;
    }

    function openByIframe() {
      const url = document.getElementById('scheme').value.trim();
      if (!url) return alert("URL ë˜ëŠ” ìŠ¤í‚´ì„ ì…ë ¥í•˜ì„¸ìš”.");
      console.log("iframe.src =", url);
      const iframe = document.createElement('iframe');
      iframe.style.display = 'none';
      iframe.src = url;
      document.body.appendChild(iframe);
    }

    function openAsLink() {
      const url = document.getElementById('scheme').value.trim();
      if (!url) return alert("URL ë˜ëŠ” ìŠ¤í‚´ì„ ì…ë ¥í•˜ì„¸ìš”.");
      const a = document.createElement('a');
      a.href = url;
      a.innerText = "í…ŒìŠ¤íŠ¸ ë§í¬ (í´ë¦­)";
      a.style.display = 'block';
      a.style.fontSize = "22px";
      a.style.marginTop = "16px";
      document.body.appendChild(a);
    }
  </script>

</body>
</html>
